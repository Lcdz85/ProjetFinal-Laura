{% extends 'base.html.twig' %}

{% block title %}Nouveau post{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ asset('styles/nouveauCarnetPost.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
{% endblock %}

{% block body %}
<main>
    <h1>Nouveau post</h1>
    <div class="container py-5" class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        
                        {{ form_start(postForm, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label">Localisation :</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-map-btn" title="Afficher/Masquer la carte">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                    </button>
                                </div>
                                <div id="map-container" class="mb-3" style="height: 300px; display: none;">
                                    <div id="map" style="height: 100%;"></div>
                                </div>
                                {{ form_widget(postForm.latitude, {'attr': {'class': 'd-none'}}) }}
                                {{ form_widget(postForm.longitude, {'attr': {'class': 'd-none'}}) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(postForm.titre, null, {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(postForm.titre, {'attr': {'class': 'form-control'}}) }}
                                <div class="invalid-feedback">
                                    {{ form_errors(postForm.titre) }}
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form_label(postForm.texte, null, {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(postForm.texte, {'attr': {'class': 'form-control', 'rows': '4'}}) }}
                                <div class="invalid-feedback">
                                    {{ form_errors(postForm.texte) }}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Photos</label>
                                <div id="photos-wrapper" data-prototype="{{ form_widget(postForm.photos.vars.prototype)|e('html_attr') }}">
                                    {{ form_widget(postForm.photos) }}
                                </div>
                                <button type="button" id="add-photo" class="btn btn-outline-secondary mt-2">
                                    <i class="bi bi-plus-circle"></i> Ajouter une photo
                                </button>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Enregistrer
                                </button>
                            </div>
                        {{ form_end(postForm) }}
        
        
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        
        <script>
        // Gestion de l'affichage de la carte
        const toggleMapBtn = document.getElementById('toggle-map-btn');
        const mapContainer = document.getElementById('map-container');
        
        toggleMapBtn.addEventListener('click', function() {
            if (mapContainer.style.display === 'none') {
                mapContainer.style.display = 'block';
                // On redimensionne la carte pour s'assurer qu'elle s'affiche correctement
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                mapContainer.style.display = 'none';
            }
        });
        
        document.getElementById('add-photo').addEventListener('click', function() {
            const list = document.getElementById('photos-wrapper');
            const index = list.children.length;
            const prototype = list.dataset.prototype.replace(/__name__/g, index);
            list.insertAdjacentHTML('beforeend', prototype);
        });
        
        // ajout localisation depuis la carte
        
        // --- Initialisation ---
                var map = L.map('map');
                var marker;
        
                // Fond de carte
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
        
                // --- Fonction d'ajout de marqueur ---
                function placeMarker(lat, lng, message = null) {
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map);
                    if (message) marker.bindPopup(message).openPopup();
                    document.getElementById('post_latitude').value = lat.toFixed(7);
                    document.getElementById('post_longitude').value = lng.toFixed(7);
                }
        
                // --- Fallback : vue par défaut sur la France ---
                function fallbackView() {
                    map.setView([46.8, 2.5], 6);
                    console.warn("Géolocalisation refusée ou indisponible. Carte centrée sur la France.");
                }
        
                // --- Tentative de géolocalisation automatique ---
                map.locate({ setView: true, maxZoom: 13 });
        
                map.on('locationfound', function(e) {
                    var lat = e.latitude;
                    var lng = e.longitude;
                    placeMarker(lat, lng, "Vous êtes ici !");
                });
        
                map.on('locationerror', fallbackView);
        
                // --- Clic manuel sur la carte ---
                map.on('click', function(e) {
                    placeMarker(e.latlng.lat, e.latlng.lng);
                });
        
                // --- Recherche d’adresse ---
                var geocoder = L.Control.geocoder({
                    defaultMarkGeocode: false
                })
                .on('markgeocode', function(e) {
                    var lat = e.geocode.center.lat;
                    var lng = e.geocode.center.lng;
                    placeMarker(lat, lng);
                    map.setView([lat, lng], 13);
                })
                .addTo(map);
        </script>
    
</main>

{% endblock %}
