{% extends 'base.html.twig' %}

{% block title %}Hello {{user.username}}!{% endblock %}


{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="{{ asset('styles/map.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/home.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
{% endblock %}

{% block body %}
<main>

    {% if app.user %}
        <div id="user-connected">
            <h1>{{ app.user.userIdentifier }}</h1>
        </div>
    {% endif %}
    
    <section class="mb-4"> 
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Localisation des posts</h4>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-map-btn" title="Afficher/Masquer la carte">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="cursor: pointer;">
                            <path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3V6z"/>
                            <path d="M9 3v15M15 6v15"/>
                            <circle cx="12" cy="12" r="2" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                <div class="card">
                    <div id="map-container">
                        <div id="map" data-api-endpoint="{{ path('api_localisations_all') }}"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    
    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Mes Carnets créés</h4>
            <input type="button" value="Ajouter un nouveau carnet" class="btn btn-outline-secondary btn-sm" onclick="window.location.href='{{ path('page_nouveau_carnet') }}'">
        </div>
        
        <div class="carnets-container">
            {% for carnet in carnetsCrees %}
                <div class="carnet">
                    <a href="{{ path('page_afficher_carnet', {'id': carnet.id}) }}">
                        <div class="card">
                            {% if carnet.photo starts with 'http' %}
                                <img src="{{ carnet.photo }}" class="card-img-top" alt="Photo du carnet">
                            {% else %}
                                <img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" class="card-img-top" alt="Photo du carnet">
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{carnet.titre}}</h5>
                                <p class="card-text">{{carnet.dateCarnet|date('d/m/Y')}}</p>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </section>
    
    <section class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Commentaires sur mes carnets</h4>
                <input type="button" value="Gestion Partage" class="btn btn-outline-secondary btn-sm" onclick="window.location.href='{{ path('page_partage') }}'">
            </div>
            
            <div class="bg-white rounded p-3" style="max-height: 400px; overflow-y: auto;">
                {% if comments is empty %}
                    <p class="text-muted text-center my-3">Aucune activité récente</p>
                {% else %}
                    <div class="row g-3">
                        {% for comment in comments|sort((a, b) => b.dateComment <=> a.dateComment) %}
                            <div class="col-md-6">
                                <a href="{{ path('page_afficher_carnet', {'id': comment.post.carnet.id}) }}#post-{{ comment.post.id }}" class="text-decoration-none text-dark">
                                    <div class="activity-item p-2 h-100 border rounded" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                        <div class="d-flex align-items-start">
                                            <div class="me-2">
                                                {% if comment.utilisateur.photo starts with 'http' %}
                                                    <img src="{{ comment.utilisateur.photo }}" alt="Avatar" class="rounded-circle">
                                                {% else %}
                                                    <img src="{{ asset('uploads/avatar/' ~ comment.utilisateur.photo) }}" alt="Avatar" class="rounded-circle"">
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong class="d-block" style="font-size: 0.9rem;">{{ comment.utilisateur.username }}</strong>
                                                        <small class="text-muted">{{ comment.dateComment|date('d/m/Y H:i') }}</small>
                                                    </div>
                                                </div>
                                                <div class="mt-1">
                                                    <div style="font-size: 0.85rem;">
                                                        <div class="text-muted">{{ comment.post.carnet.titre }}</div>
                                                        <small class="text-muted">{{ comment.post.titre }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </section>
    
    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Carnets partagés avec moi</h4>
        </div>
        <div class="carnets-container">
            {% for carnet in carnetsAcces %}
                <div class="carnet">
                    <a href="{{ path('page_afficher_carnet', {'id': carnet.id}) }}">
                        <div class="card">
                            {% if carnet.photo starts with 'http' %}
                                <img src="{{ carnet.photo }}" class="card-img-top" alt="Photo du carnet">
                            {% else %}
                                <img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" class="card-img-top" alt="Photo du carnet">
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{carnet.titre}}</h5>
                                {# <p class="card-text">{{carnet.dateCarnet|date('d/m/Y')}}</p> #}
                                <p class="card-text">par {{carnet.utilisateur.username}}</p>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </section>
    

    <script>
        // Gestion de l'affichage de la carte
        document.addEventListener('DOMContentLoaded', function() {
            const toggleMapBtn = document.getElementById('toggle-map-btn');
            const mapContainer = document.getElementById('map-container');
            let map = null;
            
            // Fonction pour initialiser la carte
            function initMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;
                
                const apiEndpoint = mapElement.dataset.apiEndpoint;
                if (!apiEndpoint) {
                    console.error('API endpoint not specified');
                    return;
                }

                // Initialiser la carte centrée sur l'Europe par défaut
                map = L.map('map').setView([48.8566, 2.3522], 3);

                // Ajouter la couche de tuiles OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Charger les marqueurs
                fetch(apiEndpoint)
                    .then(response => response.json())
                    .then(localisations => {
                        if (localisations.length === 0) {
                            console.warn('Aucune localisation dans la BD');
                            return;
                        }

                        const markers = [];
                        localisations.forEach(localisation => {
                            const lat = parseFloat(localisation.latitude);
                            const lng = parseFloat(localisation.longitude);
                            
                            if (Number.isFinite(lat) && Number.isFinite(lng)) {
                                const marker = L.marker([lat, lng]).addTo(map);
                                markers.push(marker);

                                // Créer le contenu du popup
                                marker.bindPopup(`
                                    <div class="marker-popup">
                                        <h6>${localisation.carnetTitre || 'Sans titre'}</h6>
                                        <p>${localisation.titre || ''}</p>
                                        ${localisation.photo ? `<img src="${localisation.photo}" style="max-width: 150px; max-height: 100px;" class="img-fluid mb-2">` : ''}
                                        <a href="/carnet/${localisation.carnetId}/#post-${localisation.id}" class="btn btn-sm btn-primary">Voir</a>
                                    </div>
                                `);
                            }
                        });

                        // Ajuster la vue pour afficher tous les marqueurs
                        if (markers.length > 0) {
                            const group = L.featureGroup(markers);
                            map.fitBounds(group.getBounds().pad(0.2));
                        }
                    })
                    .catch(error => {
                        console.error('Erreur de chargement des localisations:', error);
                    });
            }
            
            // Gestion du bouton de basculement de la carte
            if (toggleMapBtn && mapContainer) {
                toggleMapBtn.addEventListener('click', function() {
                    if (mapContainer.style.display === 'none') {
                        mapContainer.style.display = 'block';
                        // Initialiser la carte si ce n'est pas déjà fait
                        if (!map) {
                            initMap();
                        } else {
                            // Redimensionner la carte pour s'assurer qu'elle s'affiche correctement
                            setTimeout(() => {
                                map.invalidateSize(true);
                                // Recentrer la carte sur les marqueurs
                                if (map._layers) {
                                    const markers = [];
                                    Object.values(map._layers).forEach(layer => {
                                        if (layer instanceof L.Marker) {
                                            markers.push(layer);
                                        }
                                    });
                                    if (markers.length > 0) {
                                        const group = L.featureGroup(markers);
                                        map.fitBounds(group.getBounds().pad(0.2));
                                    }
                                }
                            }, 100);
                        }
                    } else {
                        mapContainer.style.display = 'none';
                    }
                });
            }
        });
    </script>
{% endblock %}