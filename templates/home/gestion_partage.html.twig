{% extends 'base.html.twig' %}

{% block title %}Gestion des partages
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('styles/home.css') }}">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
	<link rel="stylesheet" href="{{ asset('styles/nouveauCarnetPost.css') }}">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
	<main>
		<h1>Gestion des partages</h1>
		<section class="container">
			<div class="row justify-content-center">
				<div class="col-12 col-md-8 col-lg-6">
					<div class="card p-4 mb-4" id="form-acces">
						{{ form_start(accesForm, {
                        'attr': {
                            'id': 'form-partage',
                            'class': 'form-signin'
                        }
                    }) }}
						<div class="form-group mb-3">
							{{ form_row(accesForm.carnet, {
                            'attr': {'class': 'form-select'},
                            'row_attr': {'class': 'mb-3'}
                        }) }}
						</div>
						<div class="form-group mb-4">
							{{ form_row(accesForm.user, {
                            'attr': {'class': 'form-select'},
                            'row_attr': {'class': 'mb-3'}
                        }) }}
						</div>
						<div class="d-grid">
							<button type="submit" class="btn btn-primary">Partager</button>
						</div>
						{{ form_end(accesForm) }}
						<div id="messages" class="mt-3"></div>
					</div>
				</div>
			</div>

			<div class="row justify-content-center mt-4">
				<div class="col-12">
					<h2 class="h4 mb-4" style="text-align: center;">Mes carnets partagés</h2>
					<div class="carnets-container">
						{% for carnet in carnetsCrees %}
							<div class="carnet" id="carnet{{ carnet.id }}">
								
									<div class="card">
										<div class="position-relative">
											{% if carnet.photo starts with 'http' %}
												<img src="{{ carnet.photo }}" class="card-img-top" alt="Photo du carnet">
											{% else %}
												<img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" class="card-img-top" alt="Photo du carnet">
											{% endif %}
										</div>
										<div class="card-body">
											<h4 class="card-title">{{ carnet.titre }}</h4>
											<div class="liste-utilisateurs">
												<div class="users-list">
                                                    {% for user in carnet.usersAcces %}
                                                        <div class="d-flex align-items-center mb-1">
                                                            <span class="me-2">{{ user.username }}</span>
                                                            <form action="{{ path('supprimer_acces_carnet', { 'carnetId': carnet.id, 'userId': user.id }) }}" 
                                                                method="post" 
                                                                class="d-inline form-suppression" 
                                                                id="form-suppression-{{ carnet.id }}-{{ user.id }}">
                                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ carnet.id ~ user.id) }}">
                                                                <button type="button" 
                                                                    class="btn btn-sm btn-outline-danger p-0 px-1 btn-supprimer-acces" 
                                                                    title="Retirer l'accès"
                                                                    data-username="{{ user.username }}"
                                                                    data-carnet="{{ carnet.titre }}">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    {% endfor %}
                                                </div>
											</div>
										</div>
									</div>
								
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</section>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Gestionnaire de clic pour tous les boutons de suppression
                document.querySelectorAll('.btn-supprimer-acces').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        const username = this.getAttribute('data-username');
                        const carnet = this.getAttribute('data-carnet');
                        const form = this.closest('form');
                        
                        // Afficher la boîte de dialogue de confirmation
                        if (confirm(`Êtes-vous sûr de vouloir retirer l'accès à ${username} pour le carnet "${carnet}" ?`)) {
                            form.submit();
                        }
                    });
                });
            });
        </script>
        <script>
			document.querySelector('#form-partage').addEventListener('submit', async (e) => {
e.preventDefault();

const form = e.target;
const formData = new FormData(form);

const response = await fetch(form.action, {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest'
},
body: formData
});

const data = await response.json();
const messagesDiv = document.querySelector('#messages');
messagesDiv.innerHTML = `<div class="alert alert-${
data.status
}">${
data.message
}</div>`;

// Si partage réussi, on ajoute le user à la bonne liste
if (data.status === 'success' && data.newUser) {
const carnetDiv = document.querySelector (`#carnet${
data.newUser.carnetId
} .liste-utilisateurs`);

if (carnetDiv) {
const div = document.createElement('div');
div.textContent = data.newUser.username;
carnetDiv.appendChild(div);
}
}

// Effacer le message après quelques secondes
setTimeout(() => messagesDiv.innerHTML = '', 4000);
});
		</script>

	</main>

{% endblock %}
