{% extends 'base.html.twig' %}

{% block title %}Gestion des partages{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/home.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
<main>
    <h1>Gestion des partages</h1>
    <section>
        <div class="card p-4" id="form-acces">
            {{ form_start(accesForm, {
                'attr': {
                    'id': 'form-partage',
                    'class': 'form-signin'
                }
            }) }}
            <div class="form-group mb-3">
                <strong>{{ form_row(accesForm.carnet, {
                    'attr': {'class': 'form-select'},
                    'row_attr': {'class': 'mb-3'}
                }) }}</strong>
            </div>
            <div class="form-group mb-3">
                <strong>{{ form_row(accesForm.user, {
                    'attr': {'class': 'form-select'},
                    'row_attr': {'class': 'mb-3'}
                }) }}</strong>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Partager</button>
            </div>
            {{ form_end(accesForm) }}
            <div id="messages" class="mt-3"></div>
        </div>
        
        <div class="carnets-container">
            {% for carnet in carnetsCrees %}
                <div id="carnet{{ carnet.id }}">
                    <h4>{{ carnet.titre }}</h4>
                    {% if carnet.photo starts with 'http' %}
                    <img src="{{ carnet.photo }}" alt="Photo du carnet" width="150">
                    {% else %}
                    <img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" alt="Photo du carnet" width="150">
                    {% endif %}
                    <div class="liste-utilisateurs">
                    {% for user in carnet.usersAcces %}
                        <li>{{ user.username }}</li>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </section>
    
    <script>
        document.querySelector('#form-partage').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const form = e.target;
            const formData = new FormData(form);
    
            const response = await fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
    
            const data = await response.json();
            const messagesDiv = document.querySelector('#messages');
            messagesDiv.innerHTML = `<div class="alert alert-${data.status}">${data.message}</div>`;
    
            //  Si partage réussi, on ajoute le user à la bonne liste
            if (data.status === 'success' && data.newUser) {
                const carnetDiv = document.querySelector(`#carnet${data.newUser.carnetId} .liste-utilisateurs`);
    
                if (carnetDiv) {
                    const div = document.createElement('div');
                    div.textContent = data.newUser.username;
                    carnetDiv.appendChild(div);
                }
            }
    
            // Effacer le message après quelques secondes
            setTimeout(() => messagesDiv.innerHTML = '', 4000);
        });
        </script>
    
</main>

{% endblock %}