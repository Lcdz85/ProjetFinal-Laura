{% extends 'base.html.twig' %}

{% block title %}{{carnet.titre}}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="{{ asset('styles/map.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        .activity-item:hover {
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .post-container {
            padding: 10px 0;
        }
    </style>
{% endblock %}

{% block body %}

    {% import _self as macros %}

    {% macro render_thread(comment, carnet, isLogged) %}
        <div id="comment-{{ comment.id }}" class="mb-3 p-2 border rounded">
            <p class="mb-1">{{ comment.dateComment|date('d/m/Y') }}</p>
            <p class="mb-1"><img src="{{ comment.utilisateur.photo}}" alt="Photo de {{ comment.utilisateur.username }}" width="25"> {{ comment.utilisateur.username }}</p>
            <p class="mb-2">{{ comment.texte }}</p>
            <div class="d-flex gap-2 align-items-center mb-2">
                <button type="button" class="btn btn-outline-danger btn-sm like-comment-btn" data-id="{{ comment.id }}" aria-pressed="{{ isLogged and (app.user in comment.usersLikes) ? 'true' : 'false' }}">
                    ❤ <span id="like-count-comment-{{ comment.id }}">{{ comment.usersLikes|length }}</span>
                </button>
                {% if isLogged %}
                <button type="button" class="btn btn-outline-secondary btn-sm reply-comment-btn" data-comment-id="{{ comment.id }}" data-target="reply-form-{{ comment.id }}">Répondre</button>
                {% endif %}
            </div>
            {% if isLogged %}
                <form id="reply-form-{{ comment.id }}" class="mt-2 reply-comment-form" style="display:none;">
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <div class="mb-2">
                        <textarea name="comment_text" rows="2" class="form-control" placeholder="Votre réponse..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-outline-secondary btn-sm">Envoyer</button>
                </form>
            {% endif %}
            <div id="children-{{ comment.id }}" class="mt-2 ps-3" style="border-left: 2px solid #e5e7eb;">
                {% for child in comment.comments %}
                    {{ _self.render_thread(child, carnet, isLogged) }}
                {% endfor %}
            </div>
        </div>
    {% endmacro %}

    <main>

        <h1>{{carnet.titre}}</h1>
        <p>{{carnet.dateCarnet|date('d/m/Y')}}</p>
        {% if carnet.photo starts with 'http' %}
            <img src="{{ carnet.photo }}" alt="Photo du carnet" width="150">
        {% else %}
            <img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" alt="Photo du carnet" width="150">
        {% endif %}
        <p>par {{carnet.utilisateur.username}}</p>

    {# Accès aux posts #}
        <section class="border rounded p-3 mb-4" style="background: #f8f9fa;">
            <h4 class="text-center mb-3">Accès aux posts</h4>
            
            {# Vue par défaut: deux colonnes #}
            <div id="default-view">
                <div class="row">
                    {# Colonne gauche: activités récentes #}
                    <div class="col-md-6">
                        <h6>Dernières activités :</h6>
                        <div id="activities-list" style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px;">
                            {% set activities = [] %}
                            {# Collecter posts #}
                            {% for post in carnet.posts %}
                                {% set activities = activities|merge([{
                                    'type': 'post',
                                    'date': post.datePost,
                                    'id': post.id,
                                    'titre': post.titre,
                                    'avatar': carnet.utilisateur.photo
                                }]) %}
                                {# Collecter commentaires de ce post #}
                                {% for comment in post.comments %}
                                    {% set activities = activities|merge([{
                                        'type': 'comment',
                                        'date': comment.dateComment,
                                        'id': comment.id,
                                        'postId': post.id,
                                        'texte': comment.texte|slice(0, 50),
                                        'avatar': comment.utilisateur.photo
                                    }]) %}
                                {% endfor %}
                            {% endfor %}
                            {# Trier par date décroissante et afficher les 10 dernières #}
                            {% set activities = activities|sort((a, b) => b.date <=> a.date)|slice(0, 10) %}
                            {% for activity in activities %}
                                <div class="d-flex align-items-center mb-2 p-2 activity-item" 
                                     style="cursor: pointer; border-bottom: 1px solid #eee;"
                                     data-type="{{ activity.type }}"
                                     data-id="{{ activity.type == 'post' ? activity.id : activity.postId }}"
                                     data-comment-id="{{ activity.type == 'comment' ? activity.id : '' }}">
                                    {% if activity.avatar %}
                                        <img src="{{ activity.avatar }}" alt="Avatar" width="50" height="50" style="object-fit: cover; border-radius: 50%; margin-right: 10px;">
                                    {% else %}
                                        <div style="width: 50px; height: 50px; background: #ddd; border-radius: 4px; margin-right: 10px;"></div>
                                    {% endif %}
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.85rem;">{{ activity.date|date('d-m-Y') }}</div>
                                        <div style="font-weight: bold; font-size: 0.9rem;">
                                            {% if activity.type == 'post' %}
                                                Post
                                            {% else %}
                                                Commentaire
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {# Colonne droite: icône carte #}
                    <div class="col-md-6">
                        <h6>Depuis la carte :</h6>
                        <div style="background: white; padding: 20px; border-radius: 4px; min-height: 300px;">
                            <div class="text-center" style="padding-top: 60px;">
                                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="1.5" style="cursor: pointer;" onclick="showMapView()">
                                    <path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3V6z"/>
                                    <path d="M9 3v15M15 6v15"/>
                                    <circle cx="12" cy="12" r="2" fill="#6c757d"/>
                                </svg>
                                <p class="text-muted mt-2">Cliquer pour voir la carte</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Vue carte plein écran #}
            <div id="map-view" style="display: none; position: relative;">
                <button onclick="hideMapView()" class="btn btn-sm btn-outline-secondary mb-2" style="position: absolute; top: 10px; right: 10px; z-index: 1000;">✕</button>
                <div id="sidebar-map" style="height: 500px; width: 100%; background: white; border-radius: 4px;" data-api-endpoint="{{ path('api_localisations', { id: carnet.id }) }}"></div>
            </div>
        </section>

    {# carte #}
        <section> 
            <div class="container mt-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div id="map" data-api-endpoint="{{ path('api_localisations', { id: carnet.id }) }}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    {# bouton nouveau post #}
        {% if app.user == carnet.utilisateur %}
        <div>
            <input type="button" value="Nouveau post" class="btn btn-secondary" onclick="window.location.href='{{ path('page_nouveau_post', {'id': carnet.id}) }}'">
        </div>
        {% endif %}
        
        {# <div>
            {% if carnet.photo starts with 'http' %}
                <img src="{{ carnet.photo }}" alt="Photo du carnet" width="150">
            {% else %}
                <img src="{{ asset('uploads/carnets/' ~ carnet.photo) }}" alt="Photo du carnet" width="150">
            {% endif %}
            {% if app.user != carnet.utilisateur %}
                <p> par <strong>{{carnet.utilisateur.username}}</strong></p>
            {{carnet.dateCarnet|date('d/m/Y')}}
            {% endif %}
        </div> #}
        
        {# Posts du carnet #}
        <section>
            <h2>Posts</h2>
            <div>
                {% for post in carnet.posts %}
                    <div id="post-{{ post.id }}" class="post-container">
                    <p>{{post.datePost|date('d/m/Y')}}</p>
                    <h3>{{post.titre}}</h3>
                    {% for photo in post.photos %}
                        {% if photo.imageFile starts with 'http' %}
                            <img src="{{ photo.imageFile }}" alt="Photo du post" width="150">
                        {% else %}
                            <img src="{{ asset('uploads/posts/') ~ photo.imageFile }}" alt="Photo du post" width="150">
                        {% endif %}
                    {% endfor %}
                    <p>{{post.texte}}</p>
                    <div class="d-flex gap-2 align-items-center mb-2">
                        <button type="button" class="btn btn-outline-danger btn-sm like-post-btn" data-id="{{ post.id }}" aria-pressed="{{ app.user and (app.user in post.usersLikes) ? 'true' : 'false' }}">
                            ❤ <span id="like-count-post-{{ post.id }}">{{ post.usersLikes|length }}</span>
                        </button>
                    </div>
                    {% if app.user %}
                        <button type="button" class="btn btn-primary btn-sm add-comment-btn" data-post-id="{{ post.id }}" data-target="post-comment-form-{{ post.id }}">Ajouter un commentaire</button>
                        <form id="post-comment-form-{{ post.id }}" class="mt-2 post-comment-form" style="display:none;">
                            <input type="hidden" name="post_id" value="{{ post.id }}">
                            <div class="mb-2">
                                <textarea name="comment_text" rows="3" class="form-control" placeholder="Ajouter un commentaire..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">Publier</button>
                        </form>
                    {% endif %}
                    {% if post.comments is not empty %}
                        <h5>Commentaires</h5>
                        <div id="comments-post-{{ post.id }}">
                            {% set isLogged = app.user ? true : false %}
                            {% for comment in post.comments %}
                                {% if comment.parent is null %}
                                    {{ macros.render_thread(comment, carnet, isLogged) }}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    </div>{# end post-container #}
                <hr>
                {% endfor %}
            </div>
        </section>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="{{ asset('js/map.js') }}"></script>
        <script>
        // Map toggle functions
        let sidebarMapInstance = null;
        function showMapView() {
          document.getElementById('default-view').style.display = 'none';
          document.getElementById('map-view').style.display = 'block';
          if (!sidebarMapInstance) {
            const mapEl = document.getElementById('sidebar-map');
            const apiEndpoint = mapEl.dataset.apiEndpoint;
            sidebarMapInstance = L.map('sidebar-map').setView([49.0, 32.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
            }).addTo(sidebarMapInstance);
            fetch(apiEndpoint)
              .then(r => r.json())
              .then(locs => {
                if (!Array.isArray(locs) || locs.length === 0) return;
                const markers = [];
                locs.forEach(loc => {
                  const lat = parseFloat(loc.latitude);
                  const lng = parseFloat(loc.longitude);
                  if (Number.isFinite(lat) && Number.isFinite(lng)) {
                    const m = L.marker([lat, lng]).addTo(sidebarMapInstance);
                    m.bindPopup(`
                        <div>
                            <strong>${loc.titre}</strong><br>
                            <a href="#post-${loc.postId}" onclick="document.getElementById('post-${loc.postId}').scrollIntoView({behavior: 'smooth'}); return false;">
                                Voir le post
                            </a>
                        </div>
                    `);
                    markers.push(m);
                  }
                });
                if (markers.length > 0) {
                  const group = new L.featureGroup(markers);
                  sidebarMapInstance.fitBounds(group.getBounds().pad(0.1));
                }
              })
              .catch(() => {});
          } else {
            setTimeout(() => sidebarMapInstance.invalidateSize(), 100);
          }
        }
        function hideMapView() {
          document.getElementById('map-view').style.display = 'none';
          document.getElementById('default-view').style.display = 'block';
        }

        // Activity item click handler
        document.addEventListener('click', function(e) {
          const item = e.target.closest('.activity-item');
          if (!item) return;
          const type = item.dataset.type;
          const postId = item.dataset.id;
          const commentId = item.dataset.commentId;
          
          let targetElement = null;
          if (type === 'comment' && commentId) {
            targetElement = document.getElementById('comment-' + commentId);
          } else if (type === 'post' && postId) {
            targetElement = document.getElementById('post-' + postId);
          }
          
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            targetElement.style.background = '#fff3cd';
            setTimeout(() => { targetElement.style.background = ''; }, 2000);
          }
        });

        (function(){
          function toggleById(id){
            var el = document.getElementById(id);
            if (!el) return;
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
          }

          document.addEventListener('click', function(e){
            var addBtn = e.target.closest('.add-comment-btn');
            if (addBtn) {
              var id = addBtn.getAttribute('data-target');
              toggleById(id);
              return;
            }
            var replyBtn = e.target.closest('.reply-comment-btn');
            if (replyBtn) {
              var id2 = replyBtn.getAttribute('data-target');
              toggleById(id2);
              return;
            }
          });

          async function toggleLike(type, id){
            const fd = new FormData();
            fd.append('like_target', type);
            fd.append('like_id', id);
            const resp = await fetch('{{ path('page_afficher_carnet', { id: carnet.id }) }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd });
            if (!resp.ok) throw new Error('network');
            return resp.json();
          }

          document.addEventListener('click', function(e){
            var btnPost = e.target.closest('.like-post-btn');
            if (btnPost) {
              var id = btnPost.getAttribute('data-id');
              toggleLike('post', id)
                .then(function(json){
                  if (!json.success) return;
                  var countEl = document.getElementById('like-count-post-'+id);
                  if (countEl) countEl.textContent = json.count;
                  btnPost.setAttribute('aria-pressed', json.liked ? 'true' : 'false');
                })
                .catch(function(){});
              return;
            }
            var btnComment = e.target.closest('.like-comment-btn');
            if (btnComment) {
              var idc = btnComment.getAttribute('data-id');
              toggleLike('comment', idc)
                .then(function(json){
                  if (!json.success) return;
                  var countEl = document.getElementById('like-count-comment-'+idc);
                  if (countEl) countEl.textContent = json.count;
                  btnComment.setAttribute('aria-pressed', json.liked ? 'true' : 'false');
                })
                .catch(function(){});
            }
          });

          async function submitForm(form, url){
            const fd = new FormData(form);
            const resp = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd });
            if (!resp.ok) throw new Error('network');
            return resp.json();
          }

          function buildCommentHtml(c){
            var html = ''+
              '<div id="comment-'+c.id+'" class="mb-3 p-2 border rounded">'+
                '<p class="mb-1">'+c.date+'</p>'+
                '<p class="mb-1"><img src="'+(c.photo||'')+'" alt="Photo de '+c.username+'" width="25"> '+c.username+'</p>'+
                '<p class="mb-2"></p>'+
                '<div class="d-flex gap-2 align-items-center mb-2">'+
                  '<button type="button" class="btn btn-outline-danger btn-sm like-comment-btn" data-id="'+c.id+'" aria-pressed="false">❤ <span id="like-count-comment-'+c.id+'">0</span></button>'+
                  (document.body.dataset.logged === '1' ? ('<button type="button" class="btn btn-outline-secondary btn-sm reply-comment-btn" data-comment-id="'+c.id+'" data-target="reply-form-'+c.id+'">Répondre</button>') : '')+
                '</div>'+
                (document.body.dataset.logged === '1' ? ('<form id="reply-form-'+c.id+'" class="mt-2 reply-comment-form" style="display:none;">'+
                  '<input type="hidden" name="parent_id" value="'+c.id+'">'+
                  '<div class="mb-2"><textarea name="comment_text" rows="2" class="form-control" placeholder="Votre réponse..."></textarea></div>'+
                  '<button type="submit" class="btn btn-outline-secondary btn-sm">Envoyer</button>'+
                '</form>') : '')+
                '<div id="children-'+c.id+'" class="mt-2 ps-3" style="border-left: 2px solid #e5e7eb;"></div>'+
              '</div>';
            var wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            // Fill texte safely
            wrapper.querySelector('p.mb-2').textContent = c.texte;
            return wrapper.firstElementChild;
          }

          document.body.dataset.logged = '{{ app.user ? 1 : 0 }}';

          document.addEventListener('submit', function(e){
            var form = e.target;
            if (form.matches('.post-comment-form')) {
              e.preventDefault();
              submitForm(form, '{{ path('page_afficher_carnet', { id: carnet.id }) }}')
                .then(function(json){
                  if (!json.success) return;
                  var container = document.getElementById('comments-post-'+json.comment.postId);
                  if (!container) {
                    // create if absent
                    container = document.createElement('div');
                    container.id = 'comments-post-'+json.comment.postId;
                    var btn = form.previousElementSibling; // approx place
                    (btn ? btn.parentNode : form.parentNode).insertBefore(container, form.nextSibling);
                  }
                  var node = buildCommentHtml(json.comment);
                  container.appendChild(node);
                  form.reset();
                  form.style.display = 'none';
                })
                .catch(function(){ /* ignore */ });
            } else if (form.matches('.reply-comment-form')) {
              e.preventDefault();
              submitForm(form, '{{ path('page_afficher_carnet', { id: carnet.id }) }}')
                .then(function(json){
                  if (!json.success) return;
                  var children = document.getElementById('children-'+json.comment.parentId);
                  var node = buildCommentHtml(json.comment);
                  if (children) children.appendChild(node);
                  form.reset();
                  form.style.display = 'none';
                })
                .catch(function(){ /* ignore */ });
            }
          });
        })();
        </script>

    </main>

{% endblock %}
